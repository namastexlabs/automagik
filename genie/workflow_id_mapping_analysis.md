# üîç WORKFLOW ID MAPPING ANALYSIS

## Understanding the ID Flow

### 1. **Our IDs (We Control)**
- **run_id**: Generated by us when workflow starts (e.g., `a1ddb1a4-bef7-43ab-9cd5-80fde34d7a62`)
- **session_id**: Our database session ID (e.g., `30ce115b-b320-4f50-a793-4b62600d7c65`)
- **workflow_run_id**: Database record ID (e.g., `24d1562b-5c52-4259-ac17-f3bfd0688263`)

### 2. **Claude's IDs (Claude Controls)**
- **claude_session_id**: Generated by Claude SDK on first message (e.g., `2784a24b-0f53-47ed-8232-a3a2fd87db4e`)
- This comes in the first streaming response from Claude
- Can be reused across multiple runs

## The Problem Identified

Looking at the code flow:

1. **Workspace Creation (cli_environment.py:155)**:
   ```python
   self.active_workspaces[run_id] = worktree_path
   ```
   - Workspace is tracked by OUR run_id

2. **Claude Session ID Capture (sdk_executor.py:313)**:
   ```python
   actual_claude_session_id = message.data['session_id']
   logger.info(f"SDK Executor (SUBPROCESS): Captured REAL Claude session ID: {actual_claude_session_id}")
   ```
   - Claude's session ID is captured from the stream

3. **Workspace Lookup Failure (agent.py:1009)**:
   ```python
   claude_session_id = result.get("session_id")
   workspace_path = self.executor.environment_manager.active_workspaces.get(claude_session_id)
   ```
   - Looking for workspace using Claude's session ID
   - But workspace was stored with OUR run_id!

## The Mismatch

```
STORED: active_workspaces[run_id] = worktree_path
LOOKUP: active_workspaces[claude_session_id] = ???  # Returns None!
```

## Additional Issues Found

1. **Persistent Workspace Reuse**:
   - When persistent=True and workspace exists, it's reused
   - But the new run_id isn't added to active_workspaces mapping
   - Only the original run_id that created it is tracked

2. **Session ID Lifecycle**:
   - Claude session IDs can be reused across runs
   - Our run_ids are unique per execution
   - No mapping maintained between the two

3. **Subprocess Isolation**:
   - SDK executor runs in subprocess
   - Updates database but doesn't update parent's active_workspaces dict
   - Parent process can't find the workspace mapping

## Root Cause

The workspace tracking system uses our internal run_id for storage but tries to retrieve using Claude's session_id, with no mapping between them. Additionally, when reusing persistent workspaces, the new run_id isn't properly tracked.