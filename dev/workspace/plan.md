 
üéØ Overview

Migrate from broken legacy workflow tracking to a comprehensive workflow_runs table that captures all Claude SDK execution data, leveraging existing sessions/messages tables for human
interventions. 

üìã Complete Table Schema

CREATE TABLE workflow_runs (
-- Core Identifiers
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
run_id VARCHAR(255) UNIQUE NOT NULL,-- Claude SDK run_id

-- Workflow Definition & Type 
workflow_name VARCHAR(100) NOT NULL,-- architect, implement, test, review, fix, refactor, document, pr
agent_type VARCHAR(100), -- future extension for agent categorization 
ai_model VARCHAR(100), -- sonnet or opus for now 

-- Input & Context 
task_input TEXT NOT NULL,-- original human request message
session_id UUID REFERENCES sessions(id),-- links to existing sessions table
session_name VARCHAR(255), -- human/orchestrator chosen session name (reusable) 

-- Git Repository Context 
git_repo VARCHAR(500), -- repository URL or local path
git_branch VARCHAR(255), -- working branch for this workflow
initial_commit_hash VARCHAR(40), -- git commit hash at workflow start 
final_commit_hash VARCHAR(40), -- git commit hash at workflow completion
git_diff_added_lines INTEGER DEFAULT 0, -- + lines from git diff --stat
git_diff_removed_lines INTEGER DEFAULT 0, -- - lines from git diff --stat
git_diff_files_changed INTEGER DEFAULT 0, -- number of files modified 
git_diff_stats JSONB DEFAULT '{}',-- detailed diff breakdown per file 

-- Execution Status & Results 
status VARCHAR(50) NOT NULL DEFAULT 'pending',-- pending, running, completed, failed, killed
result TEXT,-- final workflow output/summary 
error_message TEXT, -- detailed error if status=failed 

-- Timing & Performance 
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(), 
completed_at TIMESTAMP WITH TIME ZONE, -- when workflow finished (success or failure)
duration_seconds INTEGER, -- calculated: completed_at - started_at

-- Workspace Management (Fix Current Bugs)
workspace_id VARCHAR(255),-- Claude SDK workspace identifier
workspace_persistent BOOLEAN DEFAULT true, -- should default to true (fix current false default) 
workspace_cleaned_up BOOLEAN DEFAULT false,-- whether workspace was cleaned after commit 
workspace_path VARCHAR(500),-- local filesystem workspace directory 

-- Cost & Token Tracking
cost_estimate DECIMAL(10,4),-- estimated API cost in USD 
input_tokens INTEGER DEFAULT 0, -- tokens sent to LLM
output_tokens INTEGER DEFAULT 0,-- tokens generated by LLM 
total_tokens INTEGER DEFAULT 0, -- input_tokens + output_tokens

-- User & Feedback 
user_id UUID REFERENCES users(id),-- who initiated the workflow

-- Extensible Data 
metadata JSONB DEFAULT '{}',-- extensible field for future workflow data

-- Constraints 
CONSTRAINT valid_status CHECK (status IN ('pending', 'running', 'completed', 'failed', 'killed')), 
CONSTRAINT valid_duration CHECK (duration_seconds IS NULL OR duration_seconds >= 0), 
CONSTRAINT valid_tokens CHECK (input_tokens >= 0 AND output_tokens >= 0 AND total_tokens >= 0) 
);

-- Performance Indexes 
CREATE INDEX idx_workflow_runs_run_id ON workflow_runs(run_id);
CREATE INDEX idx_workflow_runs_session_id ON workflow_runs(session_id); 
CREATE INDEX idx_workflow_runs_status ON workflow_runs(status);
CREATE INDEX idx_workflow_runs_workflow_name ON workflow_runs(workflow_name); 
CREATE INDEX idx_workflow_runs_created_at ON workflow_runs(created_at DESC);
CREATE INDEX idx_workflow_runs_user_id ON workflow_runs(user_id);
CREATE INDEX idx_workflow_runs_git_branch ON workflow_runs(git_branch); 
CREATE INDEX idx_workflow_runs_workspace_id ON workflow_runs(workspace_id); 
CREATE UNIQUE INDEX idx_workflow_runs_run_id_unique ON workflow_runs(run_id); 

-- JSONB Indexes for Metadata Queries 
CREATE INDEX idx_workflow_runs_metadata_gin ON workflow_runs USING gin(metadata); 
CREATE INDEX idx_workflow_runs_git_diff_stats_gin ON workflow_runs USING gin(git_diff_stats);

üîó Data Source Mapping 

Claude SDK Sources 

| Field | SDK Extraction Point| Method |
|---------------|---------------------------------------------------|-------------------------------|
| run_id| mcp__automagik_workflows__run_workflow() response | Direct extraction |
| status| mcp__automagik_workflows__get_workflow_status() | Poll during execution |
| result| Final workflow output| Extract on completion |
| error_message | SDK error response| When status='failed'|
| ai_model| Run metadata| Extract from workflow details |
| started_at| SDK run start timestamp| From status response|
| completed_at| SDK completion timestamp | From status response|
| workspace_id| SDK workspace metadata | Extract from run info |
| input_tokens| SDK usage statistics| From run completion data|
| output_tokens | SDK usage statistics| From run completion data|

Git Operation Sources

| Field| Git Command | Timing |
|---------------------|-------------------------------------------------|-----------------------------|
| git_repo| git remote get-url origin or local path | At workflow start |
| git_branch| Function parameter or git branch --show-current | At workflow start |
| initial_commit_hash | git rev-parse HEAD| Before workflow execution |
| final_commit_hash | git rev-parse HEAD| After workflow completion |
| git_diff_*_lines| git diff --stat initial..final | Calculate on completion |
| git_diff_stats| git diff --numstat initial..final| Detailed file-by-file stats |

System/Environment Sources

| Field| Source| Extraction | 
|----------------|------------------------|---------------------------| 
| task_input | Function parameter | Original user message | 
| session_id | Generated or existing| Link to sessions table| 
| session_name | Function parameter | Human/orchestrator chosen | 
| user_id| Current context| From authentication | 
| workspace_path | SDK workspace location | Local directory path| 
| cost_estimate| Calculated | tokens √ó model pricing| 

üîÑ Human Intervention Flow

Using Existing Sessions + Messages Infrastructure 

# Initial workflow creates/uses session
session = Session( 
id=session_uuid, 
agent_name=workflow_name,# 'builder', 'architect'
name=session_name# 'auth_system_v2' 
) 

# Initial message
initial_message = Message(
session_id=session_uuid,
role='user', 
text_content=task_input,
message_type='workflow_start' 
) 

# Human intervention = new message in same session
intervention_message = Message( 
session_id=session_uuid,# SAME session
role='user', 
text_content="Use RS256 instead", 
message_type='intervention' 
) 

# Human interventions tracked via sessions/messages tables
# No need to update workflow_runs - interventions are tracked
# through the existing message infrastructure with message_type='intervention'

# Resume workflow with additional context using Claude SDK 

üóÇÔ∏è Implementation Tasks

Phase 1: Database Schema (BUILDER)

- Create migration: 20250619_120000_create_workflow_runs_table.sql 
- Add WorkflowRun Pydantic model to src/db/models.py
- Create repository: src/db/repository/workflow_run.py
- Update central imports in src/db/__init__.py
- Add validation and helper methods 

Phase 2: Claude SDK Data Extraction (BUILDER) 

- Create WorkflowRunTracker service in src/agents/claude_code/ 
- Hook into mcp__automagik_workflows__run_workflow start 
- Implement real-time status polling and updates
- Extract all SDK fields: run_id, status, timing, tokens, workspace
- Add error handling and retry logic

Phase 3: Git Integration (BUILDER)

- Create git operations service for commit/diff tracking 
- Capture initial commit hash at workflow start 
- Calculate diff stats between initial and final commits 
- Parse git diff --stat and git diff --numstat output 
- Handle cases where no commits are made

Phase 4: Session Integration (BUILDER)

- Modify workflow execution to link with sessions table
- Leverage existing message infrastructure for human interventions
- Create resume functionality with message context from sessions/messages
- Build chat UI query functions using sessions + messages

Phase 5: Workspace Management Fix (SURGEON) 

- Set persistent=true as default in all SDK calls 
- Implement post-commit workspace cleanup logic 
- Track workspace lifecycle in workflow_runs table
- Fix workspace ID assignment and reuse

Phase 6: Legacy System Cleanup (SURGEON)

- Remove broken log_manager system entirely 
- Drop workflow_processes table (create migration)
- Clean up dead message history code
- Remove legacy workflow tracking references
- Update any dependent code 

üìä Benefits

- Single Source of Truth: Claude SDK only, no legacy systems 
- Human Intervention: Leverages existing sessions/messages for interruption/resume
- Chat UI Ready: Direct integration with existing message infrastructure
- Complete Git Tracking: Commit hashes, diff stats, branch context 
- Workspace Management: Fixes persistent workspace bugs
- Performance: Proper indexing and JSONB flexibility
- Cost Tracking: Token usage and API cost estimation
- Extensible: Metadata JSONB for future workflow data
- Simplified Schema: Removed intervention tracking fields, using existing message system